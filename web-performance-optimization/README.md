# 웹 성능 최적화

### 이미지 지연 로딩 (intersection observer)
당장 눈에 보이는 요소가 아니라면, 나중에 다운로드를 받는다. 맨 처음에 보이는 요소의 리소스만 다운받아준다.
즉 이미지를 늦게 로딩한다는 것이다. (lazy loading 이라는 워딩이 너무 적합한것 같다.) 필요할때 이미지를 로드하겠다 라는 말이다.

그렇다면 처음에 로드되지 않는 이미지들은 언제 보여져야 하는가? => 유저가 그 이미지를 보려고 할때! 비로소 리소스를 로드하면된다, 즉 스크롤 이벤트를 이용해서 스크롤이 이미지의 위치까지 도달했는지를 판단한다.

하지만 단점이 있을 것 같다.. 스크롤이벤트는 스크롤할때마다 작동하기 때문에 전체적인 성능에 불이익을 가져다주지 않을까? 사용자들이 스크롤을 많이 하는데.. 당연히 안좋을 것 같다. 오히려 이미지 지연로딩을 구현하려다가, 스크롤 이벤트로 인해 성능이 더 저하 될 수 있다. => 이 부분을 해결하기 위해서 Intersection Observer 가 나왔다.

`Intersection Observer` 는 브라우저가 자체적으로 지원하기때문에 이벤트를 등록하는 행위는 아니므로 성능적 이점을 가질 수 있다.

평소에 React에서는 타 라이브러리를 사용하고 Next.js 에서는 기본적으로 image lazy loading을 적용시켜주기 때문에 수동적으로 적용해준적이 없다.
이번에는 수동적으로 적용을 해보겠다.

img 태그의 data-src 에 src로 들어갈 이미지 소스를 넣어뒀다가, observe를 통해서 이미지 태그가 보인다면 src 에 data-src에 넣어주는 로직을 구현하면 된다.

![image](https://user-images.githubusercontent.com/69495129/195502446-fa7fb565-1408-4cee-8dcb-27f784214b2c.png)

---

### 이미지 사이즈 최적화 (용량)

lazy loading을 적용할 수 있지만, 이미지 사이즈 자체를 줄이는것이 근본적인 해결방법이다.
하지만, 말이 이미지 사이즈 최적화이지만 사실은 사이즈를 줄여서 압축을 하는것이다. 압축을 한다면 조금 퀄리티는 낮아지겠지만, 속도에 대해서 확실히 우위를 가질 수 있다.

`webp` 구글에서 나온 차세대 이미지 포맷 => JPG보다 화질은 좋지만, 용량은 적다. 많은 브라우져가 webp를 지원하지만, 지원하지 않는 몇 브라우져가 있다.

구글에서 WEBP를 알리기 위해서 다음과 같은 사이트도 운영하고 있다. 이미지를 WEBP로 변환시켜주는 것이다.<br>
[squoosh](https://squoosh.app/) 실제 사이트에 들어가보면 UX가 너무 좋게 되어있다. 변환 전과 변환 후의 이미지 차이를 확실하게 보여준다.
사이트에서 퀄리티 자체를 조절하여 용량을 줄일 수 있고, 사이즈 자체를 조절하여 용량을 줄일 수도 있다.
사이즈는 실제 이미지가 보일 사이즈의 두 배수로 조절하는것이 좋다. 왜냐하면 레티나 디스플레이 같은경우에는 화소가 일반 디스플레이의 2배 개수이기 때문이다.

> 조금이라도 더 좋은 화질 및 적은 용량으로 이미지를 사용하고 싶다면 `webp` 를 사용하는 것이 좋다!

위에서 기술한것과 같이 webp를 지원하지 않는 브라우져도 있다. 그렇다면 지원하지 않는다고 해서 이미지를 보여줄 수 없다면 엄청난 사용자의 이탈율이 생길것이다.
그를 해결하기 위해서 picture 라는 태그가 있다. 

```html
<picture>
  <source srcset="logo.webp" type="image/webp/>
  <img src="logo.png" alt="logo"/>                                                                 
</picture>  
```

위 코드는 만약 webp를지원하는 브라우져라면 srcset을 읽고, 지원하지 않는다면 아래의 img태그를 읽어라 라는 구문입니다.
지원하지 않는 브라우져에서 랜더링을 한다면 logo.png를 보여주겠죠!?

---

### 동영상 사이즈 최적화 (용량)
위 이미지 사이즈 최적화 처럼 동영상도 같은 원리로 용량을 감소시켜줍니다.
동영상이 메인 컨텐츠인 웹페이지라면, 용량을 줄여서 화질을 저하시키기 보다는 일반 화질 그대로 보여주는 게 더 좋을 것 같습니다.
구글에 온라인 동영상 압축 이라고 검색해보시면, 다음과 같은 사이트를 찾을 수 있습니다. 
[video-compressor](media.io/ko/video-compressor.html)
동영상도 이미지의 `webp` 처럼 효율이 좋은 확장자가 존재합니다. `webm` 이라는 확장자 입니다. 
위의 이미지와 같이 타 확장자를 사용하기때문에 지원하지 않는 브라우져가 존재할 수 있습니다. 위에서처럼 `webm`을 지원하지 않는다면 `mp4`를 틀어줘라! 라고 명시해줘야합니다.

여러개의 source 태그를 video 태그로 감싸주면 위에서와 같이 동작시킬 수 있습니다.

```html
<video>
  <source src="/test.webm" type="video/webm" />
  <source src="/test.mp4" type="video/mp4"/>
</video>
```

위 코드는 webm을 지원하지 않는 브라우저인 경우 자동으로 mp4 동영상을 보여줄 수 있기때문에 사용자에게 좋은 경험을 선사할 수 있습니다.

하지만, 사이즈를 저하시키면 화질을 저하시키므로 사용자의 경험에 안 좋은 영향을 줄 수 있으므로 중용을 지키는것이 하나의 중요한 덕목이 될 것 같습니다.

---

### 웹 폰트 최적화 

`폰트를 어떻게 하면 최적화 할 수 있을까?`
사이트를 보면 처음에 진입하였을때 기본폰트로 보였다가 일정 시간후에 개발자가 지정해준 폰트가 적용되는것을 보신 적이 많으실 겁니다.
폰트가 바로 적용되지 않아서 폰트가 깜빡이는 느낌도 가질 수 있습니다. 이는 사용자 경험을 저하시킬 수 있습니다.
저 또한 이런 경험이 많습니다. 이런경우 FOUT(Flash of Unstyled Text) 라는 문제점이라고 합니다.
이와 반대로 FOIT(Flash of Invisible Text) 라는 용어도 있습니다. 이는 폰트가 적용되기 전에는 텍스트를 보여주지도 말자는 것입니다. 
FOUT 와 FOIT의 차이점을 아시겠나요?!
그렇다면 언제는 FOUT가 적용되고 FOIT가 적용될까요? 이는 브라우져에 따라서 다릅니다.
우리는 이 두 문제를 어떻게 해결하고 최적화 할 수 있을까요? 우리는 2가지 방법을 적용할 수 있습니다.

1. 폰트 적용 시점 컨트롤 하기<br>
내가 직접 폰트 적용 시점을 컨트롤 하겠다.
웹 폰트의 다운로드 시점에 따라서 어떠한 방법으로 웹 폰트를 적용할지 결정하는 것입니다.
css 에는 `font-display` 속성이 있고 이 속성을 이용할 것 입니다.

- `auto` : 브라우저 기본 동작
- `block` : FOIT를 사용하겠다! 폰트 스타일이 적용되면 비로소 보여주겠다! (너무 폰트 적용이 느려질 경우 timeout을 정해줄 수 있습니다⏰)
- `swap` : FOUT를 사용하겠다. 처음에는 무조건 기본폰트를 보여줄 것이다! 그 후에 폰트를 바꿔줄 것이다~
- `fallback` : FOIT,FOUT 혼합입니다. 사용자에게 정해진 시간 이후에는 깜빡임을 보여주지 않겠다. 하지만 다운받은 폰트는 캐시할 것이다. (UX의 향상을 가져올 수 있음)
- `optional` : fallback 은 폰트 다운로드 시간을 기준으로 정해진다. 하지만 Optional은 네트워크 상태에 따라 기본폰트로 유지할지 웹 폰트를 적용할 지 결정한다.

font-display 는 자신이 진행하는 서비스에 맞게 적용하면 될 것 같다. `Google` 에서는 optional 을 권장하고 있다!<br>
저는 개인적으로 `FOUT` 가 좋습니다. 왜냐하면 사용자가 폰트의 깜빡임을 본다면 서비스의 완성도를 낮게 평가할 수 있다고 생각하기 때문입니다.<br>
`font face observer`를 사용해서 폰트가 다운로드 되었는지 체크를 하고 다운로드가 완료가 되는 순간에! 폰트의 Opacity 를 0에서 1로 애니메이션 효과를 주어서 사용자 경험을 높일 수 있습니다! 꼭 저도 적용해보고 싶습니다. 적용할 것입니다.
`react` 환경에서 사용하신다면 font의 로드를 체크하는 곳을 `useEffect` 안에 넣어주시는것을 잊지 마세요!




2. 폰트 사이즈 줄이기<br>
위에서 이미지와 동영상을 최적화 한 것처럼 용량이 큰 폰트의 줄이겠다는 것입니다.

1. 웹폰트 포멧 사용

- TTF/OTF
- WOFF
- WOFF2
- EOT

`파일 크기 EOT > TTF/OTF > WOFF > WOFF2`
포멧의 변환은 [여기](transfonter.org)서 하실 수 있습니다.

웹폰트의 사용법은 하기와 같습니다. 통상적으로 `css` file에 작성합니다.

```css
@font-face {
  font-family: NotoSansKR;
  src: url("./assets/fonts/NotoSansKR.woff2") format("woff2"),
       url("./assets/fonts/NotoSansKR.woff") format("woff"),
       url("./assets/fonts/NotoSansKR.ttf") format("truetype"),
}
```




2. local 폰트 사용


위 코드는 위에서부터 사용이 가능하다면 사용하고 사용 불가능한 브라우져라면 순차적으로 아래로 진행하면서 실행여부를 판단한 뒤 실행합니다.<br>
하지만 사용자중에 우리가 사용하려는 폰트를 이미 로컬에 갖고 있는 사람도 있을 것이고 그런 분들이라면 따로 네트워크 통신을 굳이 할 필요가 없습니다.<br>
이를 해결할 순 없을까요?<br>

`꿀팁` : 그냥 PC에서 가져와서 바로 브라우져에 적용하면 될 것 같습니다. 그럴 경우에는 다음과 같은 문법으로 사용해주면 됩니다.



```css
@font-face {
  font-family: NotoSansKR;
  
  src: local("NotoSansKR"), // 이 부분 수정
       url("./assets/fonts/NotoSansKR.woff2") format("woff2"),
       url("./assets/fonts/NotoSansKR.woff") format("woff"),
       url("./assets/fonts/NotoSansKR.ttf") format("truetype"),
}
```

