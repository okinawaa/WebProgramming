# 웹 성능 최적화

### 이미지 지연 로딩 (intersection observer)
당장 눈에 보이는 요소가 아니라면, 나중에 다운로드를 받는다. 맨 처음에 보이는 요소의 리소스만 다운받아준다.
즉 이미지를 늦게 로딩한다는 것이다. (lazy loading 이라는 워딩이 너무 적합한것 같다.) 필요할때 이미지를 로드하겠다 라는 말이다.

그렇다면 처음에 로드되지 않는 이미지들은 언제 보여져야 하는가? => 유저가 그 이미지를 보려고 할때! 비로소 리소스를 로드하면된다, 즉 스크롤 이벤트를 이용해서 스크롤이 이미지의 위치까지 도달했는지를 판단한다.

하지만 단점이 있을 것 같다.. 스크롤이벤트는 스크롤할때마다 작동하기 때문에 전체적인 성능에 불이익을 가져다주지 않을까? 사용자들이 스크롤을 많이 하는데.. 당연히 안좋을 것 같다. 오히려 이미지 지연로딩을 구현하려다가, 스크롤 이벤트로 인해 성능이 더 저하 될 수 있다. => 이 부분을 해결하기 위해서 Intersection Observer 가 나왔다.

`Intersection Observer` 는 브라우저가 자체적으로 지원하기때문에 이벤트를 등록하는 행위는 아니므로 성능적 이점을 가질 수 있다.

평소에 React에서는 타 라이브러리를 사용하고 Next.js 에서는 기본적으로 image lazy loading을 적용시켜주기 때문에 수동적으로 적용해준적이 없다.
이번에는 수동적으로 적용을 해보겠다.

img 태그의 data-src 에 src로 들어갈 이미지 소스를 넣어뒀다가, observe를 통해서 이미지 태그가 보인다면 src 에 data-src에 넣어주는 로직을 구현하면 된다.

![image](https://user-images.githubusercontent.com/69495129/195502446-fa7fb565-1408-4cee-8dcb-27f784214b2c.png)

### 이미지 사이즈 최적화 (용량)

lazy loading을 적용할 수 있지만, 이미지 사이즈 자체를 줄이는것이 근본적인 해결방법이다.
하지만, 말이 이미지 사이즈 최적화이지만 사실은 사이즈를 줄여서 압축을 하는것이다. 압축을 한다면 조금 퀄리티는 낮아지겠지만, 속도에 대해서 확실히 우위를 가질 수 있다.

`webp` 구글에서 나온 차세대 이미지 포맷 => JPG보다 화질은 좋지만, 용량은 적다. 많은 브라우져가 webp를 지원하지만, 지원하지 않는 몇 브라우져가 있다.

구글에서 WEBP를 알리기 위해서 다음과 같은 사이트도 운영하고 있다. 이미지를 WEBP로 변환시켜주는 것이다.<br>
[squoosh](https://squoosh.app/) 실제 사이트에 들어가보면 UX가 너무 좋게 되어있다. 변환 전과 변환 후의 이미지 차이를 확실하게 보여준다.
사이트에서 퀄리티 자체를 조절하여 용량을 줄일 수 있고, 사이즈 자체를 조절하여 용량을 줄일 수도 있다.
사이즈는 실제 이미지가 보일 사이즈의 두 배수로 조절하는것이 좋다. 왜냐하면 레티나 디스플레이 같은경우에는 화소가 일반 디스플레이의 2배 개수이기 때문이다.

> 조금이라도 더 좋은 화질 및 적은 용량으로 이미지를 사용하고 싶다면 `webp` 를 사용하는 것이 좋다!

위에서 기술한것과 같이 webp를 지원하지 않는 브라우져도 있다. 그렇다면 지원하지 않는다고 해서 이미지를 보여줄 수 없다면 엄청난 사용자의 이탈율이 생길것이다.
그를 해결하기 위해서 picture 라는 태그가 있다. 

```html
<picture>
  <source srcset="logo.webp" type="image/webp/>
  <img src="logo.png" alt="logo"/>                                                                 
</picture>  
```

위 코드는 만약 webp를지원하는 브라우져라면 srcset을 읽고, 지원하지 않는다면 아래의 img태그를 읽어라 라는 구문입니다.
지원하지 않는 브라우져에서 랜더링을 한다면 logo.png를 보여주겠죠!?


### 동영상 사이즈 최적화 (용량)
위 이미지 사이즈 최적화 처럼 동영상도 같은 원리로 용량을 감소시켜줍니다.
동영상이 메인 컨텐츠인 웹페이지라면, 용량을 줄여서 화질을 저하시키기 보다는 일반 화질 그대로 보여주는 게 더 좋을 것 같습니다.
구글에 온라인 동영상 압축 이라고 검색해보시면, 다음과 같은 사이트를 찾을 수 있습니다. 
[video-compressor](media.io/ko/video-compressor.html)
동영상도 이미지의 `webp` 처럼 효율이 좋은 확장자가 존재합니다. `webm` 이라는 확장자 입니다. 
위의 이미지와 같이 타 확장자를 사용하기때문에 지원하지 않는 브라우져가 존재할 수 있습니다. 위에서처럼 `webm`을 지원하지 않는다면 `mp4`를 틀어줘라! 라고 명시해줘야합니다.

여러개의 source 태그를 video 태그로 감싸주면 위에서와 같이 동작시킬 수 있습니다.

```html
<video>
  <source src="/test.webm" type="video/webm" />
  <source src="/test.mp4" type="video/mp4"/>
</video>
```

위 코드는 webm을 지원하지 않는 브라우저인 경우 자동으로 mp4 동영상을 보여줄 수 있기때문에 사용자에게 좋은 경험을 선사할 수 있습니다.

하지만, 사이즈를 저하시키면 화질을 저하시키므로 사용자의 경험에 안 좋은 영향을 줄 수 있으므로 중용을 지키는것이 하나의 중요한 덕목이 될 것 같습니다.





